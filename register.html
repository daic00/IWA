<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create Account - 2025 International Conference on Sustainable Urban Water Systems">
    <title>Create Account - IWA SUWS 2025</title>
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Register Container -->
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>Register Account</h1>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <form id="registerForm" action="#" method="POST">
                <div class="form-group">
                    <label for="username">Username <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        class="form-input" 
                        placeholder="3-20 characters (letters, numbers, underscore)"
                        required
                        pattern="[a-zA-Z0-9_]{3,20}"
                    >
                </div>

                <div class="form-group">
                    <label for="password">Password <span class="required">*</span></label>
                    <div class="password-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-input" 
                            placeholder="Please enter"
                            required
                        >
                        <button type="button" class="password-toggle" onclick="togglePassword('password', 'toggleIcon1')">
                            <i class="fas fa-eye" id="toggleIcon1"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm password <span class="required">*</span></label>
                    <div class="password-wrapper">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword" 
                            class="form-input" 
                            placeholder="Please enter your password again"
                            required
                        >
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', 'toggleIcon2')">
                            <i class="fas fa-eye" id="toggleIcon2"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="name">Name <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="form-input" 
                        placeholder="Name"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="organization">Organization <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="organization" 
                        name="organization" 
                        class="form-input" 
                        placeholder="Organization"
                        required
                    >
                </div>

                <button type="submit" class="btn-register">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </form>

            <div class="divider">
                <span>OR</span>
            </div>

            <div class="login-link">
                Already have an account? <a href="login.html">Sign In</a>
            </div>
        </div>
    </div>

    <script src="js/modal.js"></script>
    <script>
        // Load reusable modal component and initialize
        (async function loadModalComponent() {
            try {
                const res = await fetch('components/modal.html');
                const html = await res.text();
                document.body.insertAdjacentHTML('beforeend', html);
                if (typeof initModal === 'function') {
                    initModal();
                }
            } catch (e) {
                console.warn('Failed to load modal component:', e);
            }
        })();
        function togglePassword(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // 显示错误消息
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Form submission handler
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const name = document.getElementById('name').value.trim();
            const organization = document.getElementById('organization').value.trim();
            
            // 客户端验证
            if (password !== confirmPassword) {
                showError('Passwords do not match!');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters long!');
                return;
            }

            // 验证用户名格式
            const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
            if (!usernameRegex.test(username)) {
                showError('Username must be 3-20 characters (letters, numbers, underscore only)');
                return;
            }
            
            // 提交到服务器
            const submitBtn = document.querySelector('.btn-register');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Account...';
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        username,
                        password,
                        name,
                        organization
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 使用通用弹窗组件
                    openModal({
                        title: 'Registration Successful',
                        body: 'Welcome to IWA SUWS 2025!',
                        actions: [
                            {
                                text: 'Go to Profile',
                                class: 'btn-primary',
                                callback: () => { window.location.href = 'profile.html'; }
                            }
                        ]
                    });
                    // 即使用户关闭弹窗（X/ESC/点击遮罩），也跳转到 profile
                    const modalEl = document.getElementById('modal');
                    const doRedirect = () => { window.location.href = 'profile.html'; };
                    if (modalEl) {
                        const closeBtn = modalEl.querySelector('.modal-close');
                        if (closeBtn) closeBtn.addEventListener('click', doRedirect, { once: true });
                        const onBackdrop = (e) => { if (e.target === modalEl) doRedirect(); };
                        modalEl.addEventListener('click', onBackdrop, { once: true });
                        const onEsc = (e) => { if (e.key === 'Escape' && modalEl.classList.contains('active')) doRedirect(); };
                        document.addEventListener('keydown', onEsc, { once: true });
                    }
                } else {
                    showError(data.message || 'Registration failed. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                }
            } catch (error) {
                console.error('Registration error:', error);
                showError('Network error. Please check your connection and try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }
        });
    </script>
</body>
</html>
